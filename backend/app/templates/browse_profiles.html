{% extends "base.html" %}
{% set background_image = url_for('static', filename='images/browse_profiles_background.jpg') %}

{% block title %}Browse Profiles{% endblock %}

{% block content %}
<div class="container">
  <h1 class="text-center text-white mt-4">Suggested Profiles</h1>
  
  <!-- Advanced Search / Filtering Form -->
  <form action="{{ url_for('profiles.view_profiles') }}" method="GET" class="mb-4">
    <div class="row">
      <div class="col-md-3 mb-2">
        <input type="number" name="min_age" class="form-control" placeholder="Min Age">
      </div>
      <div class="col-md-3 mb-2">
        <input type="number" name="max_age" class="form-control" placeholder="Max Age">
      </div>
      <div class="col-md-3 mb-2">
        <input type="text" name="location" class="form-control" placeholder="Location">
      </div>
      <div class="col-md-3 mb-2">
        <select name="sort_by" class="form-control">
          <option value="">Sort By</option>
          <option value="age">Age</option>
          <option value="location">Location</option>
          <option value="fame_rating">Fame Rating</option>
          <option value="common_tags">Common Tags</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6 mb-2">
        <input type="text" name="interests" class="form-control" placeholder="Interests (comma separated)">
      </div>
      <div class="col-md-6 mb-2">
        <input type="number" name="fame_rating_gap" class="form-control" placeholder="Fame Rating Gap">
      </div>
    </div>
    <div class="text-center">
      <button type="submit" class="btn btn-outline-light">Advanced Search</button>
    </div>
  </form>

  <!-- Profiles List -->
  <div class="row justify-content-center">
    {% for profile in profiles %}
      <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
        <div class="card bg-dark text-white shadow-lg rounded">
          <!-- Profile Picture -->
          <img src="{{ profile.profile_picture if profile.profile_picture else url_for('static', filename='images/default.png') }}" 
               alt="Profile Picture" class="card-img-top rounded-top">

          <div class="card-body text-center">
            <!-- Name -->
            <h3 class="card-title">{{ profile.first_name }} {{ profile.last_name }}</h3>
            
            <!-- Age Calculation -->
            {% if profile.birthdate and profile.birthdate.year %}
              <p><strong>Age:</strong> {{ current_year - profile.birthdate.year }}</p>
            {% else %}
              <p><strong>Age:</strong> Unknown</p>
            {% endif %}

            <!-- Location -->
            <p>
              <strong>Location:</strong> 
              {{ profile.city if profile.city else "Unknown" }}, 
              {{ profile.country if profile.country else "Unknown" }}
            </p>

            <!-- Interests -->
            <p><strong>Interests:</strong> {{ profile.interests if profile.interests else "No interests provided" }}</p>

            <!-- Action Buttons -->
            <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
              <button class="btn btn-danger" onclick="sendLike({{ profile.user_id }})">‚ù§Ô∏è Like</button>
              {% if profile.mutual_like %}
                <a href="{{ url_for('chat.start_chat', user_id=profile.user_id) }}" class="btn btn-primary">üí¨ Chat</a>
              {% endif %}
              <button class="btn btn-secondary" onclick="blockUser({{ profile.user_id }})">üö´ Block</button>
              <button class="btn btn-warning" onclick="reportUser({{ profile.user_id }})">‚ö†Ô∏è Report</button>
              <a href="{{ url_for('profiles.edit_profile_by_id', profile_id=profile.user_id) }}" class="btn btn-info">üìÑ View Profile</a>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Button to access advanced search if not using the form above -->
<div class="text-center mt-4">
  <a href="{{ url_for('profiles.view_profiles') }}" class="btn btn-outline-light">üîç Search Profiles</a>
</div>

<!-- JavaScript Functions to Handle User Actions -->
<script>
function sendLike(userId) {
  fetch(`/likes/like`, { 
    method: 'POST', 
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ liker_id: {{ session.get('user_id') }}, liked_id: userId })
  })
  .then(response => response.json())
  .then(data => alert(data.message))
  .catch(error => console.error("Error sending like:", error));
}

function blockUser(userId) {
  fetch(`/profiles/block`, { 
    method: 'POST', 
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: userId })
  })
  .then(response => response.json())
  .then(data => alert(data.message))
  .catch(error => console.error("Error blocking user:", error));
}

function reportUser(userId) {
  fetch(`/profiles/report`, { 
    method: 'POST', 
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id: userId })
  })
  .then(response => response.json())
  .then(data => alert(data.message))
  .catch(error => console.error("Error reporting user:", error));
}
</script>
{% endblock %}








